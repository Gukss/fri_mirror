# í¬ë”© ë§¤ë‰´ì–¼

### 1. NginX ì„¤ì¹˜

```bash
sudo apt-get update
sudo apt install nginx
```

- NginXë¦¬ë²„ìŠ¤í”„ë¡ì‹œ ì„¤ì •

```bash
# sites-available, sites-enabledëŠ” ë”ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ì„¤ì •ë°©ë²•, ë”°ë¼ì„œ conf.dí´ë”ë¥¼ ìˆ˜ì •í•¨
cd etc/nginx/conf.d
sudo vim default.conf
```

- default.conf íŒŒì¼ ìƒì„± í›„ ë‚´ìš© ì±„ìš°ê¸°

```bash
server {
    listen 80;
    server_name [ë‚´ ë„ë©”ì¸];

    location / {
        proxy_pass http://192.168.XXX.XXX;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
    }
}
```

- certbot(SSL) ì„¤ì¹˜

```bash
sudo add-apt-repository ppa:certbot/certbot 

sudo apt-get update # í•´ë‹¹ ì €ì¥ì†Œì— ë‹´ê¸´ íŒ¨í‚¤ì§€ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ì—…ë°ì´íŠ¸

sudo apt-get install python3-certbot-nginx # certbot ì„¤ì¹˜

# ì„¤ì¹˜ëœ certvotì„ ì´ìš©í•˜ì—¬ ë„ë©”ì¸(example.com)ì— ëŒ€í•œ SSL ì¸ì¦ì„œ ë°œê¸‰ 
sudo certbot certonly --nginx -d j8b105.p.ssafy.io(ë„ë©”ì¸)

# ë‹¤ìŒ ê²½ë¡œì— 5ê°œì˜ íŒŒì¼(4ê°œì˜ .pem, 1ê°œì˜ readme) ìƒì„± í™•ì¸ 
sudo ls -al /etc/letsencrypt/live/j8b105.p.ssafy.io(ë„ë©”ì¸)

# 90ì¼ë§ˆë‹¤ ë§Œë£Œë˜ëŠ” ì¸ì¦ì„œ ìë™ ê°±ì‹  
sudo certbot renew --dry-run
```

- NginX ì„¤ì • íŒŒì¼ ìˆ˜ì •

```bash
# cd etc/nginx/conf.d
# sudo vim default.conf

# etc/nginx/conf.d/default.conf

# redirect ì½”ë“œ(80í¬íŠ¸ ì ‘ê·¼ ì‹œ 443ìœ¼ë¡œ)
server {
  listen 80; #80í¬íŠ¸ë¡œ ë°›ì„ ë•Œ
  #server_name k8b204.p.ssafy.io www.k8b204.p.ssafy.io; #ë„ë©”ì¸ì£¼ì†Œ, ì—†ì„ê²½ìš° localhost
  server_name meetingfri.com www.meetingfri.com;
  #return 301 https://k8b204.p.ssafy.io$request_uri;
  return https://meetingfri.com;
}
server {
  listen 443 ssl;
  #server_name k8b204.p.ssafy.io www.k8b204.p.ssafy.io;
  server_name meetingfri.com www.meetingfri.com;

  # ssl ì¸ì¦ì„œ ì ìš©í•˜ê¸°
  #ssl_certificate /etc/letsencsudo vim /etc/nginx/conf.d/default.confrypt/live/k8b204.p.ssafy.io/fullchain.pem;
   ssl_certificate /etc/letsencrypt/live/meetingfri.com/fullchain.pem;
  #ssl_certificate_key /etc/letsencrypt/live/k8b204.p.ssafy.io/privkey.pem;
  ssl_certificate_key /etc/letsencrypt/live/meetingfri.com/privkey.pem;

        location / { # í”„ë¡ íŠ¸ì—”ë“œ
                proxy_pass http://localhost:3000;
        }

  location /api { # ë°±ì—”ë“œ
    proxy_pass http://localhost:8080;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme; # https í•„ìš”

    # ì›¹ ì†Œì¼“ ì„¤ì •
    proxy_set_header Connection "upgrade";
    proxy_set_header Upgrade $http_upgrade;
  }

  location /api/v2 { # ë°±ì—”ë“œ
    proxy_pass http://localhost:8733;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme; # https í•„ìš”
     # ì›¹ ì†Œì¼“ ì„¤ì •
    proxy_set_header Connection "upgrade";
    proxy_set_header Upgrade $http_upgrade;
  }
}
```

- NginX ì¬ì‹œì‘

```bash
sudo service nginx restart
```

### 2. MySQL ì„¤ì¹˜

- MySQL APT Repository ì¶”ê°€ & íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ

```bash
sudo wget https://dev.mysql.com/get/mysql-apt-config_0.8.13-1_all.deb
sudo dpkg -i mysql-apt-config_0.8,13-1_all.deb
```

- MySQL ì„¤ì¹˜

```bash
sudo apt-get update
sudo apt-get install mysql-server
```

- ë°©í™”ë²½ í—ˆìš©(Workbench ì“°ê¸° ìœ„í•´ì„œ)

```bash
sudo ufw allow mysql
```

- MySQL ì ‘ì†

```bash
sudo /usr/bin/mysql -u root -p
```

### 3. Docker ì„¤ì¹˜

- íŒ¨í‚¤ì§€ ì •ë³´ ì—…ë°ì´íŠ¸

```bash
sudo apt-get update
```

- ê¸°ë³¸ì ì¸ ì„¤ì¹˜

```bash
sudo apt-get install \
apt-transport-https \
ca-certificates \
curl \
gnupg-agent \
software-proerties-common
```

- curlì„ ì´ìš©í•´ docker ë°ì´í„° ê°€ì ¸ì˜¤ê¸°

```bash
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add
```

- apt-key ë“±ë¡ë¬ëŠ”ì§€ í™•ì¸

```bash
apt-key fingerprint 0EBFCD88
```

- PPA ì €ì¥ì†Œ ì¶”ê°€

```bash
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"
```

- ì €ì¥ì†Œ íŒ¨í‚¤ì§€ ê°±ì‹ 

```bash
sudo apt update
```

- ë„ì»¤ ì„¤ì¹˜

```bash
sudo apt-cache policy docker-ce
sudo apt install docker-ce
```

### 4. Jenkins ì„¤ì¹˜(Docker outside of Docker)

- ì  í‚¨ìŠ¤ ì´ë¯¸ì§€ ì¶”ê°€

```bash
docker pull jenkinsci/blueocrean
```

- ì  í‚¨ìŠ¤ ì‹¤í–‰

```bash
sudo docker run -d \
-u root \
-p 9090:8080 \
--name=jenkins \
-v /home/ubuntu/docker/jenkins-data:/var/jenkins_home \
-v /var/run/docker.sock:/var/run/docker.sock \
-v "$HOME":/home/jenkinsci/blueocean \
jenkinsci/blueocean
```

- ì  í‚¨ìŠ¤ ì»¨í…Œì´ë„ˆ ì ‘ì†

```bash
sudo docker exec -it jenkins bash
```

- ì  í‚¨ìŠ¤ ì ‘ì† ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°

```bash
cat /var/jenkins_home/secrets/initialAdminPassword
```

### 5. Jenkins Pipeline êµ¬ì¶•

- Credentialì„ ìœ„í•´ Gitlab API Token ë°œê¸‰
- Jenkins Dashboard â†’ ìƒˆë¡œìš´ Item â†’ pipeline ë§Œë“¤ê¸°

### 6. Jenkins Pipeline Script(scm)

- Back ìš´ì˜ì„œë²„

```bash
pipeline{
    agent any
    environment {
       BACK_SPRING_CONTAINER_NAME="fri_back_spring_container"
       BACK_SPRING_NAME = "fri_back_spring"
    }
    stages {
        stage('Clean'){
            steps{
                script {
                    try{
                        sh "docker stop ${BACK_SPRING_CONTAINER_NAME}"
                        sleep 1
                        sh "docker rm ${BACK_SPRING_CONTAINER_NAME}"
                    }catch(e){
                        sh 'exit 0'
                    }
                }
            }
        }
        stage('Build') {
            steps {
                script{
                     sh "docker build -t ${BACK_SPRING_NAME} ./fri/."
                }
            }
        }
        stage('Deploy'){
            steps {  
                sh "docker run -d --name=${BACK_SPRING_CONTAINER_NAME} -p 8080:8080 -e JAVA_OPTS=-Djasypt.encryptor.password=hellofri ${BACK_SPRING_NAME}"
                //sh "docker run -d --name=${BACK_SPRING_CONTAINER_NAME} -p 8080:8080 -e JAVA_OPTS=-Djasypt.encryptor.password=hellofri -v /home/ubuntu/share:/usr/bin/ ${BACK_SPRING_NAME}"
                //sh "docker run -d --name=${BACK_SPRING_CONTAINER_NAME} -p 8080:8080 ${BACK_SPRING_NAME}"
                sh "docker image prune --force"
            }
        }
    }
}


```

- Back ê°œë°œ ì„œë²„

```bash
pipeline{
    agent any
    environment {
       BACK_SPRING_CONTAINER_NAME="fri_back_spring_container_dev"
       BACK_SPRING_NAME = "fri_back_spring_dev"
    }
    stages {
        stage('Clean'){
            steps{
                script {
                    try{
                        sh "docker stop ${BACK_SPRING_CONTAINER_NAME}"
                        sleep 1
                        sh "docker rm ${BACK_SPRING_CONTAINER_NAME}"
                    }catch(e){
                        sh 'exit 0'
                    }
                }
            }
        }
        stage('Build') {
            steps {
                script{
                     sh "docker build -t ${BACK_SPRING_NAME} ./fri/."
                }
            }
        }
        stage('Deploy'){
            steps {  
                sh "docker run -d --name=${BACK_SPRING_CONTAINER_NAME} -p 8733:8733 -e JAVA_OPTS=-Djasypt.encryptor.password=hellofri ${BACK_SPRING_NAME}"
                //sh "docker run -d --name=${BACK_SPRING_CONTAINER_NAME} -p 8080:8080 -e JAVA_OPTS=-Djasypt.encryptor.password=hellofri -v /home/ubuntu/share:/usr/bin/ ${BACK_SPRING_NAME}"
                //sh "docker run -d --name=${BACK_SPRING_CONTAINER_NAME} -p 8080:8080 ${BACK_SPRING_NAME}"
                sh "docker image prune --force"
            }
        }
    }
}

```

- Front

```bash
pipeline {
    agent any
    environment {
       FRONT_CONTAINER_NAME="fri_front_container"
       FRONT_NAME = "fri_front"
    }
    stages {
        stage('Clean'){
            steps{
                script {
                    try{
                        sh "docker stop ${FRONT_CONTAINER_NAME}"
                        sleep 1
                        sh "docker rm ${FRONT_CONTAINER_NAME}"
                    }catch(e){
                        sh 'exit 0'
                    }
                }
            }
        }
        stage('Build') {
            steps {
                script{
                    sh "docker build -t ${FRONT_NAME} ./fri/."
                }
            }
        }
        stage('Docker run') {
            steps {
                sh "docker run -d --name=${FRONT_CONTAINER_NAME} -p 3000:80 ${FRONT_NAME}"
                sh "docker image prune --force" 
            }
        }
    }
}
```



### 7. Dockerfile ìƒì„±

- Back ìš´ì˜ ì„œë²„

```bash
FROM openjdk:11 AS builder
COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .
COPY src src
RUN chmod =x ./gradlew
RUN ./gradlew bootJar
FROM openjdk:11

# Selenium ì‚¬ìš© ìœ„í•´ Chrome ë° Chrome WebDriver ì„¤ì¹˜
RUN apt-get update && \
   apt-get install -y wget unzip xvfb libxi6 libgconf-2-4 default-jdk libgbm-dev && \
   wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb


# NOTE dpkg -i exits nonzero due to missing dependencies
RUN dpkg -i google-chrome-stable_current_amd64.deb; apt-get install -y -f
# RUN apt install ./google-chrome-stable_current_amd64.deb; apt-get install -y -f

RUN wget https://chromedriver.storage.googleapis.com/112.0.5615.49/chromedriver_linux64.zip && \
    unzip chromedriver_linux64.zip && \
    mv chromedriver /usr/bin/chromedriver && \
    chmod +x /usr/bin/chromedriver

COPY --from=builder build/libs/fri-0.0.1-SNAPSHOT.jar fri.jar

EXPOSE 8080

ENTRYPOINT ["sh", "-c", "java ${JAVA_OPTS} -jar fri.jar"]
#ENTRYPOINT ["java", "-jar", "fri.jar"]

```

- Back ê°œë°œ ì„œë²„

```bash
FROM openjdk:11 AS builder
COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .
COPY src src
RUN chmod =x ./gradlew
RUN ./gradlew bootJar
FROM openjdk:11

# Selenium ì‚¬ìš© ìœ„í•´ Chrome ë° Chrome WebDriver ì„¤ì¹˜
RUN apt-get update && \
   apt-get install -y wget unzip xvfb libxi6 libgconf-2-4 default-jdk libgbm-dev && \
   wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb


# NOTE dpkg -i exits nonzero due to missing dependencies
RUN dpkg -i google-chrome-stable_current_amd64.deb; apt-get install -y -f
# RUN apt install ./google-chrome-stable_current_amd64.deb; apt-get install -y -f

RUN wget https://chromedriver.storage.googleapis.com/112.0.5615.49/chromedriver_linux64.zip && \
    unzip chromedriver_linux64.zip && \
    mv chromedriver /usr/bin/chromedriver && \
    chmod +x /usr/bin/chromedriver

COPY --from=builder build/libs/fri-0.0.1-SNAPSHOT.jar fri.jar

EXPOSE 8733

ENTRYPOINT ["sh", "-c", "java ${JAVA_OPTS} -jar fri.jar"]
#ENTRYPOINT ["java", "-jar", "fri.jar"]

```

- Front

```bash
# Dockerfile

FROM node:18.16.0 as builder
# root ì— app í´ë”ë¥¼ ìƒì„±
RUN mkdir /app

WORKDIR /app

COPY . /app

RUN npm install

RUN npm run build

# work dir ì— build í´ë” ìƒì„± /app/build

# host pcì˜ í˜„ì¬ê²½ë¡œì˜ build í´ë”ë¥¼ workdir ì˜ build í´ë”ë¡œ ë³µì‚¬
# nginx ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ë’¤ì— tagê°€ ì—†ìœ¼ë©´ latest ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
FROM nginx

# nginx ì˜ default.conf ë¥¼ ì‚­ì œ
RUN rm /etc/nginx/conf.d/default.conf

# host pc ì˜ nginx.conf ë¥¼ ì•„ë˜ ê²½ë¡œì— ë³µì‚¬
COPY ./nginx.conf /etc/nginx/conf.d

COPY --from=builder /app/build /usr/share/nginx/html

# 80 í¬íŠ¸ ì˜¤í”ˆ
EXPOSE 80

# container ì‹¤í–‰ ì‹œ ìë™ìœ¼ë¡œ ì‹¤í–‰í•  command. nginx ì‹œì‘í•¨
CMD ["nginx", "-g", "daemon off;"]
```


---

## ë°±ì—”ë“œ ymlíŒŒì¼

- ìš´ì˜ server
```
server:
  port: 8080
  error:
    whitelabel:
      enabled: false
  servlet:
    context-path: /api


spring:
  datasource:
    driver-class-name: org.mariadb.jdbc.Driver
    #ì„œë²„ìš©
    url: ENC(upYg2gFoNX6LVCDQsjv1ssJJR62cSC/dmkwSEs1V8JH0Awd7dm6ltdNeot09aHsIkWRIxIQNMOI=)
    username: ENC(1r8bussQYmMrfJCfg4h1mQ==)
    password: ENC(pXp97hELSeLXhz+isZEfFK+2QKlpEQ+0)
    #ë¡œì»¬ìš©
#    url: jdbc:mariadb://localhost:3307/fri
#    username: root
#    password: ssafy

  #  email:
  #    properties:

  #  mail:
  #    host: smtp.gmail.com
  #    port: 587
  #    username: no.reply.eggfri@gmail.com
  #    password: xueepbwrdkjymbup
  #    properties:
  #      mail:
  #        smtp:
  #          auth: true
  #          starttls:
  #            enable: true



  jpa:
    open-in-view: false
    show-sql: true
    hibernate:
      # ddl-auto: create
      ddl-auto: none
#      ddl-auto: update

    properties:
      hibernate:
        # sql ë³€ìˆ˜ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ``ìœ¼ë¡œ ê°ì‹¸ì¤€ë‹¤.
        globally_quoted_identifiers: true
        # ì½˜ì†”ì— ëœ¨ëŠ” sql ë³´ê¸° ì¢‹ê²Œ ë§Œë“¤ì–´ì¤€ë‹¤.
        format_sql: true

mail:
  smtp:
    auth: true
    starttls:
      required: true
      enable: true
    socketFactory:
      class: javax.net.ssl.SSLSocketFactory
      fallback: false
      port: 465
    port: 465

# admin êµ¬ê¸€ ê³„ì •
AdminMail:
  id: no.reply.eggfri@gmail.com
  password: ENC(6lYSRkQQ3fJQ6qKTjHXYCMD+dmB7BCkXmdXNIpNOZCk=)

jasypt:
  encryptor:
    bean: jasyptStringEncryptor

logging:
  level:
    org:
      hibernate:
        SQL: DEBUG
        type:
          descriptor:
            sql:
              BasicBinder: TRACE

cloud:
  aws:
    credentials:
      accessKey: ENC(o7x5UFdTtq6HEPsoilBpx5Hc/2cmcSoHqZ0l11kqdjw=)
      secretKey: ENC(GezhgTAYqhHKsQDTi2yHj/EQO7ezy49WRRSn5wK1l4WMtbg+h0guOp9SFtAKmccEPaa1Cnrsfbc=)
    s3:
      bucket: meetingfri    # ex) marryting-gyunny
    #      dir: /blur # ex) /gyunny
    region:
      static: ap-northeast-2
    stack:
      auto: false

```

- ê°œë°œ server
```
server:
  # ìš´ì˜
  #port: 8080

  #ê°œë°œ
  port: 8733
  error:
    whitelabel:
      enabled: false
  servlet:
    #ìš´ì˜
    #context-path: /api

    #ê°œë°œ
    context-path: /api/v2


spring:
  datasource:
    driver-class-name: org.mariadb.jdbc.Driver
    #ì„œë²„ìš©-ìš´ì˜
#    url: ENC(upYg2gFoNX6LVCDQsjv1ssJJR62cSC/dmkwSEs1V8JH0Awd7dm6ltdNeot09aHsIkWRIxIQNMOI=)
#    username: ENC(1r8bussQYmMrfJCfg4h1mQ==)
#    password: ENC(pXp97hELSeLXhz+isZEfFK+2QKlpEQ+0)

    #ì„œë²„ìš©-ê°œë°œ
    url: ENC(Pisukd31oO4oeL6LjxlpHR+HC4mDqQ5OfIIWMem1iMU7iJe0glpyPlM3+fLGMnUzMoU5/TOMihU=)
    username: ENC(1r8bussQYmMrfJCfg4h1mQ==)
    password: ENC(pXp97hELSeLXhz+isZEfFK+2QKlpEQ+0)

    #ë¡œì»¬ìš©
#    url: jdbc:mariadb://localhost:3307/fri
#    username: root
#    password: ssafy

  #  email:
  #    properties:

  #  mail:
  #    host: smtp.gmail.com
  #    port: 587
  #    username: no.reply.eggfri@gmail.com
  #    password: xueepbwrdkjymbup
  #    properties:
  #      mail:
  #        smtp:
  #          auth: true
  #          starttls:
  #            enable: true



  jpa:
    open-in-view: false
    show-sql: true
    hibernate:
      # ddl-auto: create
      # ddl-auto: none
     ddl-auto: update

    properties:
      hibernate:
        # sql ë³€ìˆ˜ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ``ìœ¼ë¡œ ê°ì‹¸ì¤€ë‹¤.
        globally_quoted_identifiers: true
        # ì½˜ì†”ì— ëœ¨ëŠ” sql ë³´ê¸° ì¢‹ê²Œ ë§Œë“¤ì–´ì¤€ë‹¤.
        format_sql: true

mail:
  smtp:
    auth: true
    starttls:
      required: true
      enable: true
    socketFactory:
      class: javax.net.ssl.SSLSocketFactory
      fallback: false
      port: 465
    port: 465

# admin êµ¬ê¸€ ê³„ì •
AdminMail:
  id: no.reply.eggfri@gmail.com
  password: ENC(6lYSRkQQ3fJQ6qKTjHXYCMD+dmB7BCkXmdXNIpNOZCk=)

jasypt:
  encryptor:
    bean: jasyptStringEncryptor

logging:
  level:
    org:
      hibernate:
        SQL: DEBUG
        type:
          descriptor:
            sql:
              BasicBinder: TRACE

cloud:
  aws:
    credentials:
      accessKey: ENC(o7x5UFdTtq6HEPsoilBpx5Hc/2cmcSoHqZ0l11kqdjw=)
      secretKey: ENC(GezhgTAYqhHKsQDTi2yHj/EQO7ezy49WRRSn5wK1l4WMtbg+h0guOp9SFtAKmccEPaa1Cnrsfbc=)
    s3:
      bucket: meetingfri    # ex) marryting-gyunny
    #      dir: /blur # ex) /gyunny
    region:
      static: ap-northeast-2
    stack:
      auto: false

```

---

## ğŸ’¾ í¬íŒ… ë§¤ë‰´ì–¼

|í¬íŠ¸ | ìœ í˜• | í”„ë¡œê·¸ë¨ | ì‚¬ìš©í¬íŠ¸ë‚´ìš©|
|--- | --- | --- | ---|
|22 | TCP | SSH | Ubuntu ì ‘ì†ì„ ìœ„í•´|
|80 | TCP | HTTP | HTTP ê¸°ë³¸ Port|
|443 | TCP | HTTPS | HTTPS ê¸°ë³¸ Port|
|3000 | TCP | DOCKER, REACT | fri_front_containerì˜ react port|
|3306 | TCP | DOCKER, MariaDB | MariaDB server Port|
|8080 | TCP | DOCKER, Spring | fri_back_containerì˜ Spring ìš´ì˜ Port|
|8733 | TCP | DOCKER, Spring | fri_back_container_devì˜ Spring ê°œë°œ Port|
|9090 | TCP | DOCKER, Jenkins | Jenkins Port(8080 â†’ 9090)|


